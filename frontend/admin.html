<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rapid Maternal | Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; padding: 20px; background: #f8f9fa; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #adminEmergencies th, #adminEmergencies td { vertical-align: middle; }
        #registerContainer { padding: 20px; background: #fff; border-radius: 8px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); margin-top: 10px; }
        #escResult, #rm_result { margin-top: 8px; font-weight: 500; }
    </style>
</head>
<body>
    <header>
        <h2>Admin Console</h2>
        <div>
            <span id="userInfo"></span>
            <button class="btn btn-sm btn-outline-danger" onclick="logout()">Logout</button>
        </div>
    </header>

    <section class="mb-4">
        <h5>Run Escalation</h5>
        <button id="runEsc" class="btn btn-primary btn-sm">Run Now</button>
        <div id="escResult"></div>
    </section>

    <section class="mb-4">
        <h5>Register Midwife</h5>
        <button id="showRegisterBtn" class="btn btn-success btn-sm mb-2">Register Midwife</button>
        <div id="registerContainer" style="display:none;">
            <form id="registerMidwifeForm" class="row g-2">
                <div class="col-md-3">
                    <input id="rm_full_name" placeholder="Full name" required class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <input id="rm_username" placeholder="Username" required class="form-control form-control-sm">
                </div>
                <div class="col-md-3">
                    <input id="rm_email" placeholder="Email" class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <input id="rm_password" placeholder="Password" type="password" required class="form-control form-control-sm">
                </div>
                <div class="col-md-2">
                    <input id="rm_facility_name" placeholder="Facility name" required class="form-control form-control-sm">
                </div>
                <div class="col-12">
                    <button type="submit" class="btn btn-success btn-sm mt-2">Register</button>
                </div>
            </form>
            <div id="rm_result"></div>
        </div>
        <div style="margin-top:10px">
            <button id="showManageBtn" class="btn btn-secondary btn-sm">Manage Midwives</button>
        </div>
        <div id="manageMidwivesSection" style="display:none; margin-top:10px">
            <h3>Manage Midwives</h3>
            <table id="usersTable" class="table table-sm table-bordered" style="width:100%;border-collapse:collapse">
                <thead><tr><th>ID</th><th>Name</th><th>Username</th><th>Role</th><th>Facility</th><th>Action</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </section>

    <section>
        <h5>Emergencies (All)</h5>
        <div class="table-responsive">
            <table id="adminEmergencies" class="table table-striped table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Facility</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Ack By</th>
                        <th>Escalation</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </section>
  
    

    <script src="js/auth.js"></script>
    <script>
        const user = getCurrentUser();
        if (!user) window.location.href = "login.html";
        const role = (user.role || '').toUpperCase();
        if (role !== 'ADMIN' && role !== 'SUBDISTRICT_ADMIN') window.location.href = 'index.html';
        document.getElementById('userInfo').innerText = `${user.sub} (${user.role})`;

        const API = 'http://127.0.0.1:8000';
        const token = localStorage.getItem('access_token');

        // Run Escalation
        document.getElementById('runEsc').addEventListener('click', async () => {
            const btn = document.getElementById('runEsc');
            btn.disabled = true;
            const escResult = document.getElementById('escResult');
            escResult.innerText = 'Running...';
            try {
                const res = await fetch(`${API}/emergencies/escalate/run`, { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
                const data = await res.json();
                escResult.innerText = `Escalated: ${data.escalated || 0}`;
            } catch (err) {
                console.error(err);
                escResult.innerText = 'Error running escalation';
            }
            btn.disabled = false;
        });

        // Toggle register form
        const showBtn = document.getElementById('showRegisterBtn');
        const regContainer = document.getElementById('registerContainer');
        showBtn.addEventListener('click', () => {
            if (regContainer.style.display === 'none' || regContainer.style.display === '') {
                regContainer.style.display = 'block';
                showBtn.innerText = 'Hide Register Form';
            } else {
                regContainer.style.display = 'none';
                showBtn.innerText = 'Register Midwife';
            }
        });

        // Register midwife
        document.getElementById('registerMidwifeForm').addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const full_name = document.getElementById('rm_full_name').value.trim();
            const username = document.getElementById('rm_username').value.trim();
            const email = document.getElementById('rm_email').value.trim();
            const password = document.getElementById('rm_password').value;
            const facility_name = document.getElementById('rm_facility_name').value.trim();
            const out = document.getElementById('rm_result');
            out.style.color = 'green';
            out.innerText = 'Registering...';
            try {
                const payload = { full_name, username, email, password, role: 'MIDWIFE', facility_name };
                const res = await fetch(`${API}/auth/register/midwife`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    const err = await res.json().catch(() => ({ detail: res.statusText }));
                    out.style.color = 'red';
                    out.innerText = err.detail || 'Registration failed';
                    return;
                }
                const data = await res.json();
                out.style.color = 'green';
                out.innerText = `Registered ${data.username}`;
                document.getElementById('registerMidwifeForm').reset();
            } catch (err) {
                console.error(err);
                out.style.color = 'red';
                out.innerText = 'Server error';
            }
        });

        // Load emergencies
        async function loadAdminEmergencies() {
            try {
                const res = await fetch(`${API}/emergencies/`, { headers: { 'Authorization': 'Bearer ' + token } });
                if (!res.ok) throw new Error('Failed to load emergencies');
                const list = await res.json();
                const tbody = document.querySelector('#adminEmergencies tbody');
                tbody.innerHTML = '';
                list.forEach(e => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${e.id}</td><td>${e.facility_name||e.facility_id||'-'}</td><td>${e.emergency_type}</td><td>${e.status}</td><td>${e.acknowledged_by||'-'}</td><td>${e.escalation_level||'-'}</td><td></td>`;
                    const td = tr.querySelector('td:last-child');
                    if (e.status !== 'acknowledged') {
                        const btn = document.createElement('button');
                        btn.innerText = 'Acknowledge';
                        btn.className = 'btn btn-sm btn-warning';
                        btn.onclick = async () => {
                            btn.disabled = true;
                            try {
                                const ackRes = await fetch(`${API}/emergencies/${e.id}/acknowledge`, {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                                    body: JSON.stringify({ acknowledged_by: user.sub })
                                });
                                if (!ackRes.ok) {
                                    const t = await ackRes.text();
                                    alert('Ack failed: ' + t);
                                    return;
                                }
                                await loadAdminEmergencies();
                            } catch (err) {
                                console.error(err);
                                alert('Server error');
                            }
                            btn.disabled = false;
                        };
                        td.appendChild(btn);
                    }
                    tbody.appendChild(tr);
                });
            } catch (err) { console.error(err); }
        }

        loadAdminEmergencies();
        setInterval(loadAdminEmergencies, 10000);
        
                // Load users for management (midwives)
                async function loadUsers(){
                    try{
                        const res = await fetch(API + '/users/', { headers: { 'Authorization': 'Bearer ' + token } });
                        if(!res.ok) throw new Error('Failed to load users');
                        const list = await res.json();
                        const tbody = document.querySelector('#usersTable tbody');
                        tbody.innerHTML = '';
                        list.forEach(u=>{
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${u.id}</td><td>${u.full_name||'-'}</td><td>${u.username}</td><td>${u.role}</td><td>${u.facility_name||u.facility_id||'-'}</td><td></td>`;
                            const td = tr.querySelector('td:last-child');
                            // allow remove button for midwives
                            if ((u.role||'').toUpperCase() === 'MIDWIFE'){
                                const btn = document.createElement('button');
                                btn.innerText = 'Remove';
                                btn.onclick = async ()=>{
                                    if(!confirm('Remove midwife '+u.username+'?')) return;
                                    btn.disabled = true;
                                    try{
                                        const dres = await fetch(API + `/users/${u.id}`, { method:'DELETE', headers:{ 'Authorization': 'Bearer '+token }});
                                        if(!dres.ok){ const t = await dres.json().catch(()=>null); alert('Failed: '+(t?.detail||dres.statusText)); btn.disabled=false; return; }
                                        await loadUsers();
                                    }catch(err){ console.error(err); alert('Server error'); btn.disabled=false }
                                };
                                td.appendChild(btn);
                            }
                            tbody.appendChild(tr);
                        });
                    }catch(err){ console.error(err); }
                }
        
                // Manage midwives toggle
                const showManageBtn = document.getElementById('showManageBtn');
                const manageSection = document.getElementById('manageMidwivesSection');
                let usersInterval = null;
                showManageBtn.addEventListener('click', ()=>{
                    if (manageSection.style.display === 'none' || manageSection.style.display === ''){
                        manageSection.style.display = 'block';
                        showManageBtn.innerText = 'Hide Midwives';
                        loadUsers();
                        usersInterval = setInterval(loadUsers, 15000);
                    } else {
                        manageSection.style.display = 'none';
                        showManageBtn.innerText = 'Manage Midwives';
                        if (usersInterval) { clearInterval(usersInterval); usersInterval = null; }
                    }
                });

    </script>
</body>
</html>
